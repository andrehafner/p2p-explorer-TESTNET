# NGINX Configuration for Ergo TestNet Explorer
# Copy this to /etc/nginx/sites-enabled/ergo-testnet
#
# Prerequisites:
# - Cloudflare Origin Certificate at /etc/ssl/cloudflare/origin.pem
# - Cloudflare Origin Certificate Key at /etc/ssl/cloudflare/origin.key
#
# Note: Do NOT add CORS headers here - the backend already handles CORS.
# Adding them in NGINX causes duplicate headers which browsers reject.

# TestNet UI - Frontend (port 3002)
server {
    listen 443 ssl http2;
    server_name testnet.ergoplatform.com;
    ssl_certificate     /etc/ssl/cloudflare/origin.pem;
    ssl_certificate_key /etc/ssl/cloudflare/origin.key;

    location / { proxy_pass http://localhost:3002; }
}

# TestNet API - Backend REST API (port 8080)
server {
    listen 443 ssl http2;
    server_name api-testnet.ergoplatform.com;
    ssl_certificate     /etc/ssl/cloudflare/origin.pem;
    ssl_certificate_key /etc/ssl/cloudflare/origin.key;

    location / {
        proxy_pass http://localhost:8080;
        # Rewrite requests without /api/v0 or /api/v1 prefix to use /api/v0
        rewrite ^(?!/api/v[0-9])(/.*)$ /api/v0$1 break;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# TestNet GraphQL (port 3001)
server {
    listen 443 ssl http2;
    server_name gql-testnet.ergoplatform.com;
    ssl_certificate     /etc/ssl/cloudflare/origin.pem;
    ssl_certificate_key /etc/ssl/cloudflare/origin.key;

    location / { proxy_pass http://localhost:3001; }
}
